(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const p={boardSize:800,playingArea:720,borderWidth:40,pocketRadius:26,innerBase:235,outerBase:265,cornerCircleR:16,largeCircleR:235,middleCircleR:90,centerCircleR:15,padding:50,getPockets:function(){return[{x:105,y:105},{x:795,y:105},{x:105,y:795},{x:795,y:795}]},getBounds:function(){return{minX:90,minY:90,maxX:810,maxY:810}},getBaselines:function(){const o=450+(this.innerBase+this.outerBase)/2,e=450-(this.innerBase+this.outerBase)/2,t=450-this.outerBase,s=450+this.outerBase;return{bottom:{y:o,startX:t,endX:s,cutoutTargetLine:this.cornerCircleR},top:{y:e,startX:t,endX:s,cutoutTargetLine:this.cornerCircleR},left:{x:e,startY:t,endY:s,cutoutTargetLine:this.cornerCircleR},right:{x:o,startY:t,endY:s,cutoutTargetLine:this.cornerCircleR}}}};class q{constructor(){this.bodies=[],this.velocityIterations=15,this.onCollision=null,this.boardBounds=p.getBounds(),this.wallRestitution=.8}addBody(e){this.bodies.push(e)}removeBody(e){this.bodies=this.bodies.filter(t=>t!==e)}step(e){for(let t of this.bodies)t.update(e);for(let t=0;t<this.velocityIterations;t++)this._resolveBodyCollisions(),this._resolveWallCollisions()}_resolveBodyCollisions(){const e=this.bodies,t=e.length;for(let s=0;s<t;s++){const i=e[s];for(let n=s+1;n<t;n++){const r=e[n];if(i.isSleeping&&r.isSleeping)continue;const a=r.pos.x-i.pos.x,l=r.pos.y-i.pos.y,h=a*a+l*l,c=i.radius+r.radius;if(h<c*c){let m=Math.sqrt(h),y,f;m===0?(y=1,f=0,m=.1):(y=a/m,f=l/m);const u=c-m,S=Math.max(u-.01,0)/(i.invMass+r.invMass)*.8,g=y*S,P=f*S;i.pos.x-=g*i.invMass,i.pos.y-=P*i.invMass,r.pos.x+=g*r.invMass,r.pos.y+=P*r.invMass;const w=r.vel.x-i.vel.x,k=r.vel.y-i.vel.y,T=w*y+k*f;if(T>0)continue;let C=-(1+Math.min(i.restitution,r.restitution))*T;C/=i.invMass+r.invMass;const B=y*C,E=f*C;if(i.vel.x-=B*i.invMass,i.vel.y-=E*i.invMass,r.vel.x+=B*r.invMass,r.vel.y+=E*r.invMass,this.onCollision&&C>.5){const R=(i.pos.x+r.pos.x)/2,_=(i.pos.y+r.pos.y)/2;this.onCollision("body",R,_,C)}}}}}_resolveWallCollisions(){for(let e of this.bodies)e.isSleeping||(e.pos.x-e.radius<this.boardBounds.minX?(e.pos.x=this.boardBounds.minX+e.radius,e.vel.x<0&&(e.vel.x*=-this.wallRestitution)):e.pos.x+e.radius>this.boardBounds.maxX&&(e.pos.x=this.boardBounds.maxX-e.radius,e.vel.x>0&&(e.vel.x*=-this.wallRestitution)),e.pos.y-e.radius<this.boardBounds.minY?(e.pos.y=this.boardBounds.minY+e.radius,e.vel.y<0&&(e.vel.y*=-this.wallRestitution)):e.pos.y+e.radius>this.boardBounds.maxY&&(e.pos.y=this.boardBounds.maxY-e.radius,e.vel.y>0&&(e.vel.y*=-this.wallRestitution)))}renderDebug(e){e.strokeStyle="#0f0",e.beginPath();const t=this.boardBounds;e.rect(t.minX,t.minY,t.maxX-t.minX,t.maxY-t.minY),e.stroke();for(let s of this.bodies)e.fillStyle=s.color,e.beginPath(),e.arc(s.pos.x,s.pos.y,s.radius,0,Math.PI*2),e.fill()}}const F={"Classic Teak":{woodDark:"#a67d53",surface:"#e0cfae",lines:"#111111",linesAlpha:1,pocket:"#000000",pocketSupport:"#000000",redAccent:"#d26052"}};let v=F["Classic Teak"];typeof CanvasRenderingContext2D<"u"&&!CanvasRenderingContext2D.prototype.roundRect&&(CanvasRenderingContext2D.prototype.roundRect=function(o,e,t,s,i){typeof i=="number"&&(i={tl:i,tr:i,br:i,bl:i});const n={tl:0,tr:0,br:0,bl:0,...i};return this.beginPath(),this.moveTo(o+n.tl,e),this.lineTo(o+t-n.tr,e),this.quadraticCurveTo(o+t,e,o+t,e+n.tr),this.lineTo(o+t,e+s-n.br),this.quadraticCurveTo(o+t,e+s,o+t-n.br,e+s),this.lineTo(o+n.bl,e+s),this.quadraticCurveTo(o,e+s,o,e+s-n.bl),this.lineTo(o,e+n.tl),this.quadraticCurveTo(o,e,o+n.tl,e),this.closePath(),this});class O{constructor(){this.virtualSize=900,this.center={x:450,y:450},this.cacheCanvas=document.createElement("canvas"),this.cacheCanvas.width=this.virtualSize,this.cacheCanvas.height=this.virtualSize,this.cacheCtx=this.cacheCanvas.getContext("2d"),this.isCached=!1}_prerender(){if(this.isCached)return;const e=this.cacheCtx;e.clearRect(0,0,this.virtualSize,this.virtualSize),this.drawOuterFrame(e),this.drawSurface(e),this.drawPockets(e),e.save(),e.translate(this.center.x,this.center.y),this.drawLines(e),e.restore(),this.isCached=!0}render(e){this.isCached||this._prerender(),e.drawImage(this.cacheCanvas,0,0)}drawOuterFrame(e){const{padding:t,boardSize:s}=p;e.shadowColor="rgba(0,0,0,0.8)",e.shadowBlur=30,e.shadowOffsetY=15,e.fillStyle=v.woodDark,e.beginPath(),e.roundRect(t,t,s,s,20),e.fill(),e.shadowColor="transparent",e.shadowBlur=0,e.shadowOffsetY=0}drawSurface(e){const{padding:t,borderWidth:s,playingArea:i}=p,n=t+s;e.fillStyle=v.surface,e.beginPath(),e.roundRect(n,n,i,i,5),e.fill(),e.strokeStyle=v.lines,e.lineWidth=2,e.stroke()}drawPockets(e){p.getPockets().forEach(s=>{e.fillStyle=v.pocket,e.beginPath(),e.arc(s.x,s.y,p.pocketRadius,0,Math.PI*2),e.fill();const i=e.createRadialGradient(s.x,s.y,p.pocketRadius*.2,s.x,s.y,p.pocketRadius);i.addColorStop(0,"rgba(0,0,0,1)"),i.addColorStop(1,"rgba(0,0,0,0.5)"),e.fillStyle=i,e.beginPath(),e.arc(s.x,s.y,p.pocketRadius,0,Math.PI*2),e.fill(),e.strokeStyle=v.pocketSupport,e.lineWidth=5,e.beginPath(),e.arc(s.x,s.y,p.pocketRadius+1,0,Math.PI*2),e.stroke()})}drawLines(e){e.strokeStyle=v.lines,e.globalAlpha=v.linesAlpha,this.drawLargeOverlays(e),this.drawCenterArea(e),this.drawDiagonals(e),this.drawBaselines(e),e.globalAlpha=1}drawLargeOverlays(e){e.lineWidth=1.5,e.beginPath(),e.arc(0,0,p.largeCircleR,0,Math.PI*2),e.stroke(),e.beginPath(),e.arc(0,0,p.middleCircleR,0,Math.PI*2),e.stroke()}drawCenterArea(e){e.lineWidth=1.5,e.beginPath(),e.arc(0,0,p.centerCircleR,0,Math.PI*2),e.stroke(),e.beginPath(),e.arc(0,0,4,0,Math.PI*2),e.fillStyle=v.lines,e.fill()}drawDiagonals(e){e.lineWidth=1.5;const s=i=>{e.save(),e.rotate(i);const n=300,r=140;e.beginPath(),e.moveTo(n,0),e.lineTo(r,0),e.stroke();const a=16;e.beginPath(),e.arc(160,0,a,0,Math.PI*2),e.stroke(),e.beginPath(),e.arc(r,0,a,0,Math.PI*2),e.stroke(),e.restore()};s(Math.PI/4),s(3*Math.PI/4),s(5*Math.PI/4),s(7*Math.PI/4)}drawBaselines(e){e.lineWidth=1.5;const t=p.outerBase,s=p.innerBase,i=p.cornerCircleR,n=(a,l,h,c)=>{e.beginPath(),e.moveTo(a,l),e.lineTo(h,c),e.stroke()};n(-t,-t,t,-t),n(-t,-s,t,-s),n(-t,t,t,t),n(-t,s,t,s),n(-t,-t,-t,t),n(-s,-t,-s,t),n(t,-t,t,t),n(s,-t,s,t);const r=(a,l)=>{e.beginPath(),e.arc(t*a,t*l,i,0,Math.PI*2),e.globalCompositeOperation="destination-out",e.fill(),e.globalCompositeOperation="source-over",e.stroke(),e.beginPath(),e.arc(s*a,s*l,i,0,Math.PI*2),e.fillStyle=v.redAccent,e.fill(),e.lineWidth=1.5,e.strokeStyle=v.lines,e.stroke()};r(1,1),r(1,-1),r(-1,1),r(-1,-1)}}class d{constructor(e=0,t=0){this.x=e,this.y=t}set(e,t){return this.x=e,this.y=t,this}copy(e){return this.x=e.x,this.y=e.y,this}clone(){return new d(this.x,this.y)}add(e){return this.x+=e.x,this.y+=e.y,this}sub(e){return this.x-=e.x,this.y-=e.y,this}mult(e){return this.x*=e,this.y*=e,this}div(e){return e!==0&&(this.x/=e,this.y/=e),this}magSq(){return this.x*this.x+this.y*this.y}mag(){return Math.sqrt(this.magSq())}normalize(){const e=this.mag();return e>0&&this.div(e),this}distSq(e){const t=this.x-e.x,s=this.y-e.y;return t*t+s*s}dist(e){return Math.sqrt(this.distSq(e))}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}limit(e){return this.magSq()>e*e&&this.normalize().mult(e),this}static add(e,t){return new d(e.x+t.x,e.y+t.y)}static sub(e,t){return new d(e.x-t.x,e.y-t.y)}static mult(e,t){return new d(e.x*t,e.y*t)}static dot(e,t){return e.x*t.x+e.y*t.y}}class N{constructor(e,t,s,i,n="piece"){this.pos=new d(e,t),this.vel=new d(0,0),this.radius=s,this.mass=i,this.invMass=i===0?0:1/i,this.type=n,this.color="#fff",this.highlight="#fff",this.isSleeping=!0,this.restitution=.88}applyImpulse(e,t=null){this.invMass!==0&&(this.vel.x+=e.x*this.invMass,this.vel.y+=e.y*this.invMass,this.isSleeping=!1)}update(e,t=1){this.vel.mult(Math.pow(.985*t,e*120)),this.vel.magSq()<.09?(this.vel.set(0,0),this.isSleeping=!0):this.isSleeping=!1,this.pos.x+=this.vel.x*e,this.pos.y+=this.vel.y*e}}class I extends N{constructor(e,t,s,i=1,n="piece"){super(e,t,s,i,n),this.restitution=.88,this.isActive=!0,this.rings=[[1,"#555"],[.7,"#ccc"]],this.highlight="rgba(255,255,255,0.4)"}render(e){if(!this.isActive)return;const{x:t,y:s}=this.pos,i=this.radius;e.save(),e.shadowColor="rgba(0,0,0,0.6)",e.shadowBlur=10,e.shadowOffsetX=4,e.shadowOffsetY=4;const[n,r]=this.rings[0];e.fillStyle=r,e.beginPath(),e.arc(t,s,i*n,0,Math.PI*2),e.fill(),e.restore();for(let l=1;l<this.rings.length;l++){const[h,c]=this.rings[l];e.fillStyle=c,e.beginPath(),e.arc(t,s,i*h,0,Math.PI*2),e.fill()}const a=e.createRadialGradient(t-i*.4,s-i*.4,i*.05,t,s,i*1.2);a.addColorStop(0,"rgba(255, 255, 255, 0.6)"),a.addColorStop(.3,"rgba(255, 255, 255, 0.1)"),a.addColorStop(.7,"rgba(0, 0, 0, 0.1)"),a.addColorStop(1,"rgba(0, 0, 0, 0.5)"),e.fillStyle=a,e.beginPath(),e.arc(t,s,i,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.2)",e.lineWidth=1,e.beginPath(),e.arc(t,s,i,0,Math.PI*2),e.stroke()}}class D extends I{constructor(e,t){super(e,t,18,1,"black"),this.rings=[[1,"#1A1A1A"],[.65,"#F0F0F0"],[.5,"#222222"],[.18,"#F0F0F0"]],this.highlight="rgba(255,255,255,0.2)"}}class L extends I{constructor(e,t){super(e,t,18,1,"white"),this.rings=[[1,"#FDFDFD"],[.65,"#1A1A1A"],[.5,"#F0F0F0"],[.18,"#1A1A1A"]],this.highlight="rgba(255,255,255,0.7)"}}class A extends I{constructor(e,t){super(e,t,18,1,"queen"),this.rings=[[1,"#D10056"],[.65,"#FFFFFF"],[.5,"#E60073"],[.18,"#FFFFFF"]],this.highlight="rgba(255, 100, 200, 0.5)"}}class G extends I{constructor(e,t){super(e,t,24,2.85,"striker"),this.rings=[[1,"#0019C4"],[.85,"#FFFFFF"],[.72,"#0A31FF"],[.58,"#FFFFFF"],[.45,"#0A31FF"],[.25,"#FFFFFF"],[.08,"#0A31FF"]],this.highlight="rgba(255, 255, 255, 0.6)",this.restitution=.85}}const x={arrangeStandard(o){const n=new A(450,450);o.addBody(n);const r=[];for(let h=0;h<6;h++)r.push(-Math.PI/2+h*(Math.PI/3));for(let h=0;h<6;h++){const c=r[h],m=450+Math.cos(c)*36.36,y=450+Math.sin(c)*36.36,f=h%2===0?new L(m,y):new D(m,y);o.addBody(f)}for(let h=0;h<6;h++){const c=r[h],m=450+Math.cos(c)*36.36*2,y=450+Math.sin(c)*36.36*2;o.addBody(new D(m,y));const f=r[h]+Math.PI/6,u=36.36*Math.sqrt(3),M=450+Math.cos(f)*u,b=450+Math.sin(f)*u;o.addBody(new L(M,b))}const a=p.getBaselines(),l=new G(450,a.bottom.y);return o.addBody(l),l}};class Y{constructor(e,t){this.canvas=e,this.virtualSize=t,this.pointerDown=!1,this.pointerPos=new d(0,0),this.pointerStart=new d(0,0),this.events={onStart:null,onMove:null,onEnd:null},this._bindEvents()}_bindEvents(){this.canvas.addEventListener("mousedown",this._onStart.bind(this)),window.addEventListener("mousemove",this._onMove.bind(this)),window.addEventListener("mouseup",this._onEnd.bind(this)),this.canvas.addEventListener("touchstart",e=>this._onStart(e.touches[0],!0),{passive:!1}),window.addEventListener("touchmove",e=>this._onMove(e.touches[0],!0),{passive:!1}),window.addEventListener("touchend",this._onEnd.bind(this))}_getVirtualPos(e,t){const s=this.canvas.getBoundingClientRect(),i=this.virtualSize/s.width,n=this.virtualSize/s.height;return new d((e-s.left)*i,(t-s.top)*n)}_onStart(e,t=!1){t&&e.preventDefault&&e.preventDefault();const s=this._getVirtualPos(e.clientX,e.clientY);this.pointerDown=!0,this.pointerPos.copy(s),this.pointerStart.copy(s),this.events.onStart&&this.events.onStart(s)}_onMove(e,t=!1){if(!this.pointerDown)return;const s=this._getVirtualPos(e.clientX,e.clientY);this.pointerPos.copy(s),this.events.onMove&&this.events.onMove(s)}_onEnd(){this.pointerDown&&(this.pointerDown=!1,this.events.onEnd&&this.events.onEnd(this.pointerPos))}}class ${constructor(e){this.physics=e,this.maxReflections=3}predict(e,t){let s=e.pos.clone(),i=t.clone();const n=[s.clone()];let r=null,a=null,l=null,h=0,c=p.getBounds(),m=this.physics.bodies.filter(f=>f!==e),y=t.mag()*1.5;if(y<10)return{path:n,hitPiece:r,hitPos:a,ghostVelocity:l};for(let f=0;f<this.maxReflections+1&&y>0;f++){let u=this._findNextCollision(s,i,e.radius,c,m);if(u){let M=s.dist(u.point);if(y-=M,s=u.point,n.push(s.clone()),u.type==="piece"){r=u.piece,a=s.clone();const b=-i.x,S=-i.y,g=b*u.normal.x+S*u.normal.y,P=-(1+r.restitution)*g/(e.invMass+r.invMass);l=new d(-u.normal.x*P*r.invMass,-u.normal.y*P*r.invMass);break}else if(u.type==="wall"){const b=i.dot(u.normal);if(i.x-=2*b*u.normal.x,i.y-=2*b*u.normal.y,h++,h>=this.maxReflections)break}}else{i.normalize(),s.x+=i.x*y,s.y+=i.y*y,n.push(s.clone());break}}return{path:n,hitPiece:r,hitPos:a,ghostVelocity:l}}_findNextCollision(e,t,s,i,n){let r=1/0,a=null,l=t.x,h=t.y;if(l>0){let c=(i.maxX-s-e.x)/l;c>.001&&c<r&&(r=c,a={type:"wall",point:new d(i.maxX-s,e.y+h*c),normal:new d(-1,0)})}else if(l<0){let c=(i.minX+s-e.x)/l;c>.001&&c<r&&(r=c,a={type:"wall",point:new d(i.minX+s,e.y+h*c),normal:new d(1,0)})}if(h>0){let c=(i.maxY-s-e.y)/h;c>.001&&c<r&&(r=c,a={type:"wall",point:new d(e.x+l*c,i.maxY-s),normal:new d(0,-1)})}else if(h<0){let c=(i.minY+s-e.y)/h;c>.001&&c<r&&(r=c,a={type:"wall",point:new d(e.x+l*c,i.minY+s),normal:new d(0,1)})}for(let c of n){let m=e.x-c.pos.x,y=e.y-c.pos.y,f=l*l+h*h,u=2*(m*l+y*h),M=s+c.radius,b=m*m+y*y-M*M,S=u*u-4*f*b;if(S>=0){let g=(-u-Math.sqrt(S))/(2*f);if(g>.001&&g<r){r=g;let P=new d(e.x+l*g,e.y+h*g),w=P.x-c.pos.x,k=P.y-c.pos.y,T=Math.sqrt(w*w+k*k);a={type:"piece",piece:c,point:P,normal:new d(w/T,k/T)}}}}return a}}class V{constructor(e,t){this.striker=e,this.physicsWorld=t,this.predictor=new $(t),this.state="IDLE",this.maxPowerDist=200,this.maxVelocity=3400,this.currentPower=0,this.aimRefDir=new d(0,-1),this.predictionData=null,this.domPower=document.getElementById("power-bar-fill"),this.domPowerText=document.getElementById("power-display"),this.domAngleText=document.getElementById("angle-display")}handleStart(e,t="bottom"){const i=p.getBaselines()[t],n=60;if(this.striker.pos.distSq(e)<=this.striker.radius*this.striker.radius*4){this.state="DRAG_CHECK",this.currentPower=0,this.predictionData=null;return}let a=!1;t==="bottom"||t==="top"?Math.abs(e.y-i.y)<n&&e.x>i.startX-20&&e.x<i.endX+20&&(a=!0,this.state="POSITIONING",this.striker.pos.x=Math.max(i.startX,Math.min(i.endX,e.x))):Math.abs(e.x-i.x)<n&&e.y>i.startY-20&&e.y<i.endY+20&&(a=!0,this.state="POSITIONING",this.striker.pos.y=Math.max(i.startY,Math.min(i.endY,e.y))),a||(this.state="AIMING",this.currentPower=0,this.predictionData=null)}handleMove(e,t,s="bottom"){const i=t.x-e.x,n=t.y-e.y;if(this.state==="DRAG_CHECK"&&Math.sqrt(i*i+n*n)>5&&(s==="bottom"||s==="top"?Math.abs(i)>Math.abs(n)?this.state="POSITIONING":this.state="AIMING":Math.abs(n)>Math.abs(i)?this.state="POSITIONING":this.state="AIMING"),this.state==="POSITIONING"){const a=p.getBaselines()[s];if(s==="bottom"||s==="top"){const l=Math.max(a.startX,Math.min(a.endX,e.x));this.striker.pos.x=l}else{const l=Math.max(a.startY,Math.min(a.endY,e.y));this.striker.pos.y=l}}else if(this.state==="AIMING"){const r=new d(i,n),a=r.mag();a>5&&this.aimRefDir.copy(r).normalize();const l=Math.min(a/this.maxPowerDist,1);if(this.currentPower=l,this.currentPower>.02){const h=new d(this.aimRefDir.x,this.aimRefDir.y);h.mult(this.currentPower*this.maxVelocity),this.predictionData=this.predictor.predict(this.striker,h)}else this.predictionData=null;this.updateDOM()}}handleEnd(e,t){if(this.state==="AIMING"&&this.currentPower>.02){const s=new d(this.aimRefDir.x,this.aimRefDir.y);return s.mult(this.currentPower*this.maxVelocity),this.striker.vel.copy(s),this.striker.isSleeping=!1,this.state="IDLE",this.currentPower=0,this.predictionData=null,this.updateDOM(),!0}return this.state="IDLE",this.currentPower=0,this.predictionData=null,this.updateDOM(),!1}updateDOM(){if(this.domPower){const e=Math.round(this.currentPower*100);this.domPower.style.width=`${e}%`,this.domPowerText.innerText=`${e}%`;let t="#ffffff";e>75?t="#ff4400":e>50?t="#ffa500":e>25&&(t="#ffff00"),this.domPower.style.background=t;let s=Math.atan2(this.aimRefDir.y,this.aimRefDir.x)*(180/Math.PI);s=Math.round(s<0?s+360:s),this.domAngleText.innerText=`${s}¬∞`}}render(e){if(this.state==="AIMING"){let t=255,s=255-this.currentPower*200,i=255-this.currentPower*255;const n=`rgba(${t}, ${Math.max(0,s)}, ${Math.max(0,i)}`;if(this.predictionData&&this.predictionData.path.length>1){const r=this.predictionData.path;e.lineWidth=3;for(let a=0;a<r.length-1;a++){const l=.8-a*.2;e.strokeStyle=`${n}, ${l})`,a>0?e.setLineDash([8,8]):e.setLineDash([]),e.beginPath(),e.moveTo(r[a].x,r[a].y),e.lineTo(r[a+1].x,r[a+1].y),e.stroke()}if(e.setLineDash([]),this.predictionData.hitPos&&(e.strokeStyle=`${n}, 0.6)`,e.setLineDash([4,4]),e.beginPath(),e.arc(this.predictionData.hitPos.x,this.predictionData.hitPos.y,this.striker.radius,0,Math.PI*2),e.stroke(),e.setLineDash([]),this.predictionData.ghostVelocity&&this.predictionData.hitPiece)){const a=new d(this.predictionData.hitPiece.pos.x+this.predictionData.ghostVelocity.x*.05,this.predictionData.hitPiece.pos.y+this.predictionData.ghostVelocity.y*.05);e.strokeStyle="rgba(255,255,255,0.3)",e.beginPath(),e.moveTo(this.predictionData.hitPiece.pos.x,this.predictionData.hitPiece.pos.y),e.lineTo(a.x,a.y),e.stroke()}}else{e.strokeStyle=`${n}, 0.5)`,e.lineWidth=3,e.setLineDash([10,15]),e.beginPath(),e.moveTo(this.striker.pos.x,this.striker.pos.y);const r=400*this.currentPower+100;e.lineTo(this.striker.pos.x+this.aimRefDir.x*r,this.striker.pos.y+this.aimRefDir.y*r),e.stroke(),e.setLineDash([])}e.strokeStyle=`${n}, 0.8)`,e.lineWidth=3,e.beginPath(),e.arc(this.striker.pos.x,this.striker.pos.y,this.striker.radius+15+this.currentPower*10,0,Math.PI*2),e.stroke()}}}class W{constructor(e,t){this.physics=e,this.pockets=p.getPockets(),this.triggerRadiusSq=32*32,this.onPocketedCallback=t}update(){for(let e=this.physics.bodies.length-1;e>=0;e--){let t=this.physics.bodies[e];for(let s of this.pockets){const i=t.pos.x-s.x,n=t.pos.y-s.y;if(i*i+n*n<this.triggerRadiusSq){this._handlePocket(t,e);break}}}}_handlePocket(e,t){this.physics.bodies.splice(t,1),this.onPocketedCallback&&this.onPocketedCallback(e)}}class X{constructor(e){this.engine=e,this.currentState="MENU"}setState(e){this.currentState!==e&&(console.log(`State Transition: ${this.currentState} -> ${e}`),this.currentState=e,e==="PLAYING"?this.engine.aimingSystem&&(this.engine.aimingSystem.state="IDLE"):e==="SIMULATING"||e==="EVALUATING"&&this.engine.turnManager.evaluateShot())}update(){this.currentState==="SIMULATING"&&this.engine.isBoardSleeping()&&this.setState("EVALUATING")}}class z{constructor(e){this.engine=e,this.players=[],this.activePlayerIndex=0,this.activePlayer=null,this.turnPocketed=[],this.initPlayers(2)}initPlayers(e){this.players=[];let t;e===2?t=["bottom","top"]:e===3?t=["bottom","right","top"]:t=["bottom","right","top","left"];for(let s=0;s<e;s++)this.players.push({id:s+1,name:`P${s+1}`,score:0,fouls:0,baseline:t[s]});e===2?(this.players[0].color="white",this.players[1].color="black"):e===4?(this.players[0].color="white",this.players[1].color="black",this.players[2].color="white",this.players[3].color="black"):this.players.forEach(s=>s.color=null),this.activePlayerIndex=0,this.activePlayer=this.players[0]}onPiecePocketed(e){if(this.turnPocketed.push(e),e.type==="striker")this._showSplash("foul-splash");else if(e.type==="queen")this._showSplash("queen-splash"),this.engine.scoreSystem.addPoints(this.activePlayer,50);else if((e.type==="white"||e.type==="black")&&(this.activePlayer.color||(this.activePlayer.color=e.type),e.type===this.activePlayer.color)){const t=e.type==="white"?20:10;this.engine.scoreSystem.addPoints(this.activePlayer,t)}this.engine.uiController&&this.engine.uiController.updatePocketedVisuals(this.players,this.engine.physicsWorld.bodies)}evaluateShot(){let e=!1,t=!1;const s=this.engine.foulSystem,i=this.engine.queenSystem;this.engine.scoreSystem;let n=!1,r=0,a=!1;for(let h of this.turnPocketed)h.type==="striker"?n=!0:h.type==="queen"?a=!0:(h.type==="white"||h.type==="black")&&(this.activePlayer.color||(this.activePlayer.color=h.type),h.type===this.activePlayer.color&&r++);n&&(s.handleStrikerFoul(this.activePlayer),e=!0),e&&r>0&&(this.activePlayer.dues=(this.activePlayer.dues||0)+r),a&&!e&&(i.handleQueenPocketed(this.activePlayer),t=!0),i.evaluateCover(this.activePlayer,r,e),e||r>0&&(t=!0),s.processDues(this.activePlayer),this.turnPocketed=[],this._checkBoardEnd()||((e||!t)&&this._switchTurn(),this._resetStriker(),this.engine.stateMachine.currentState!=="GAME_OVER"&&this.engine.stateMachine.setState("PLAYING")),this.engine.uiController&&this.engine.uiController.updatePocketedVisuals(this.players,this.engine.physicsWorld.bodies)}_checkBoardEnd(){if(!this.activePlayer.color)return!1;if(this.engine.physicsWorld.bodies.filter(t=>t.type===this.activePlayer.color).length===0){const t=this.players.find(n=>n.color&&n.color!==this.activePlayer.color)||this.players[1],s=this.engine.queenSystem;if(this.engine.physicsWorld.bodies.some(n=>n.type==="queen"))console.log("Foul: Pocketed last piece before Queen! Opponent wins the board."),this.engine.scoreSystem.evaluateBoardEnd(t,this.activePlayer,!0);else{const n=s.queenCoveredBy===this.activePlayer;this.engine.scoreSystem.evaluateBoardEnd(this.activePlayer,t,n)}return!0}return!1}_switchTurn(){this.activePlayerIndex=(this.activePlayerIndex+1)%this.players.length,this.activePlayer=this.players[this.activePlayerIndex],this._updateTurnHUD()}_resetStriker(){const e=this.engine.striker,t=p.getBaselines();e.vel.set(0,0),e.isSleeping=!0;const s=this.activePlayer.baseline;s==="bottom"?e.pos.set(450,t.bottom.y):s==="top"?e.pos.set(450,t.top.y):s==="left"?e.pos.set(t.left.x,450):s==="right"&&e.pos.set(t.right.x,450),this.engine.physicsWorld.bodies.includes(e)||this.engine.physicsWorld.addBody(e)}_updateTurnHUD(){this.engine.uiController&&this.engine.uiController.updateTurnHUD(this.activePlayer.id)}_showSplash(e){const t=document.getElementById(e);t&&(t.classList.remove("hidden"),t.style.animation="none",t.offsetHeight,t.style.animation=null,setTimeout(()=>{t.classList.add("hidden")},1500))}}class H{constructor(e){this.engine=e}handleStrikerFoul(e){console.log(`FOUL: ${e.name} pocketed the striker.`),e.fouls+=1,e.dues=(e.dues||0)+1,this.processDues(e)}processDues(e){if(!e.dues||e.dues<=0||!e.color)return;this.engine.physicsWorld.bodies.filter(s=>s.type===e.color).length<9?(this._returnPiece(e.color),e.dues-=1,e.dues>0&&this.processDues(e)):console.log(`${e.name} owes a Due but has no pieces pocketed yet! It remains outstanding.`)}_returnPiece(e){const i=e==="white"?new L(450,450):new D(450,450);this.engine.physicsWorld.addBody(i)}}class U{constructor(e){this.engine=e,this.queenPocketedBy=null,this.queenCoveredBy=null,this.needsCover=!1,this.justPocketed=!1}handleQueenPocketed(e){console.log(`QUEEN Pocketed by ${e.name}. Must cover!`),this.queenPocketedBy=e,this.queenCoveredBy=null,this.needsCover=!0,this.justPocketed=!0}evaluateCover(e,t,s){if(this.needsCover){if(this.justPocketed){s?(console.log("Foul while pocketing Queen! Queen returns."),this._returnQueen()):t>0?(console.log("QUEEN POCKETED AND COVERED IN SAME SHOT!"),this._markCovered()):(console.log("Queen pocketed, needs cover on next shot."),this.justPocketed=!1);return}if(this.queenPocketedBy!==e){console.log("Cover failed! Player changed. Queen returns to board."),this._returnQueen();return}t>0&&!s?(console.log("QUEEN COVERED SUCCESSFULLY!"),this._markCovered()):s?(console.log("Foul during Queen cover! Queen returns."),this._returnQueen()):(console.log("Cover shot failed (no pieces pocketed). Queen returns."),this._returnQueen())}}_markCovered(){this.queenCoveredBy=this.queenPocketedBy,this.needsCover=!1,this.justPocketed=!1}_returnQueen(){this.engine.restoreQueen(),this._resetState()}_resetState(){this.queenPocketedBy=null,this.queenCoveredBy=null,this.needsCover=!1,this.justPocketed=!1}}class Q{constructor(e){this.engine=e,this.winningScore=150}addPoints(e,t){e.score+=t,console.log(`${e.name} scored ${t} points! Total: ${e.score}`),this._updateHUD(e),this.checkWin(e)}deductPoints(e,t){this._updateHUD(e)}evaluateBoardEnd(e,t,s){const i=this.engine.physicsWorld.bodies.filter(r=>r.type===t.color);let n=0;for(const r of i)n+=r.type==="white"?20:10;s&&(n+=50),this.addPoints(e,n),e.score<this.winningScore&&t.score<this.winningScore&&(this.engine.uiController&&this.engine.uiController.showBoardEnd(this.engine.turnManager.players,e,n),setTimeout(()=>{this.engine.resetBoard()},3e3))}checkWin(e){e.score>=this.winningScore&&(console.log(`============= ${e.name} WINS THE GAME! =============`),this.engine.stateMachine.setState("GAME_OVER"),this.engine.uiController&&this.engine.uiController.showGameOver(e,this.engine.turnManager.players))}_updateHUD(e){const t=document.getElementById(`score-p${e.id}`);t&&(t.innerText=e.score)}}class j{constructor(){const e=window.AudioContext||window.webkitAudioContext;this.ctx=new e,this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=.4,this.masterGain.connect(this.ctx.destination)}resume(){this.ctx.state==="suspended"&&this.ctx.resume()}playCollision(e){this.resume();const t=this.ctx.createOscillator(),s=this.ctx.createGain();t.type="triangle",t.frequency.setValueAtTime(400+e*400,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(100,this.ctx.currentTime+.08);let i=Math.min(e*.4+.05,.6);s.gain.setValueAtTime(i,this.ctx.currentTime),s.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.08),t.connect(s),s.connect(this.masterGain),t.start(),t.stop(this.ctx.currentTime+.08)}playPocketed(e){this.resume();const t=this.ctx.createOscillator(),s=this.ctx.createGain();e==="queen"?(t.type="sine",t.frequency.setValueAtTime(880,this.ctx.currentTime),t.frequency.setValueAtTime(1108,this.ctx.currentTime+.1),t.frequency.setValueAtTime(1318,this.ctx.currentTime+.2),s.gain.setValueAtTime(.4,this.ctx.currentTime),s.gain.linearRampToValueAtTime(0,this.ctx.currentTime+.5),t.connect(s),s.connect(this.masterGain),t.start(),t.stop(this.ctx.currentTime+.5)):e==="striker"?(t.type="sawtooth",t.frequency.setValueAtTime(150,this.ctx.currentTime),t.frequency.linearRampToValueAtTime(100,this.ctx.currentTime+.25),s.gain.setValueAtTime(.3,this.ctx.currentTime),s.gain.linearRampToValueAtTime(0,this.ctx.currentTime+.25),t.connect(s),s.connect(this.masterGain),t.start(),t.stop(this.ctx.currentTime+.25)):(t.type="sine",t.frequency.setValueAtTime(300,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(60,this.ctx.currentTime+.2),s.gain.setValueAtTime(.5,this.ctx.currentTime),s.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.2),t.connect(s),s.connect(this.masterGain),t.start(),t.stop(this.ctx.currentTime+.2))}}class K{constructor(){this.particles=[],this.maxParticles=500}emitSparks(e,t,s=5,i="#FFD700",n=1){for(let r=0;r<s&&!(this.particles.length>=this.maxParticles);r++){const a=Math.random()*Math.PI*2,l=Math.random()*(100*n)+50,h=Math.random()*.3+.2;this.particles.push({x:e,y:t,vx:Math.cos(a)*l,vy:Math.sin(a)*l,life:h,maxLife:h,color:i,size:Math.random()*3+1})}}emitDust(e,t){for(let s=0;s<15&&!(this.particles.length>=this.maxParticles);s++){const i=Math.random()*Math.PI*2,n=Math.random()*80+20,r=Math.random()*.4+.3;this.particles.push({x:e,y:t,vx:Math.cos(i)*n,vy:Math.sin(i)*n,life:r,maxLife:r,color:"rgba(255,255,255,0.4)",size:Math.random()*4+2})}}update(e){for(let t=this.particles.length-1;t>=0;t--){let s=this.particles[t];if(s.life-=e,s.life<=0){this.particles.splice(t,1);continue}s.vx*=.95,s.vy*=.95,s.x+=s.vx*e,s.y+=s.vy*e}}render(e){if(this.particles.length!==0){e.save();for(let t of this.particles){const s=t.life/t.maxLife;e.globalAlpha=s,e.fillStyle=t.color,e.beginPath(),e.arc(t.x,t.y,t.size,0,Math.PI*2),e.fill()}e.restore()}}}class J{constructor(){this.storageKey="carrom_save_data",this.data={coins:0,level:1,xp:0,stats:{gamesPlayed:0,wins:0,fouls:0,queensPocketed:0},settings:{volume:.8,theme:"Classic Teak",difficulty:"medium"}},this.load()}load(){try{const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);this.data={...this.data,...t},t.stats&&(this.data.stats={...this.data.stats,...t.stats}),t.settings&&(this.data.settings={...this.data.settings,...t.settings})}}catch(e){console.warn("Could not load save data",e)}}save(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.data))}catch(e){console.warn("Could not save data",e)}}addCoins(e){this.data.coins+=e,this.save()}addXP(e){this.data.xp+=e;const t=this.data.level*1e3;this.data.xp>=t&&(this.data.level++,this.data.xp-=t,console.log(`Level Up! You are now level ${this.data.level}`)),this.save()}}class Z{constructor(e){this.engine=e,this.storage=e.storageManager,this.domMenuLayer=document.getElementById("ui-layer");const t=document.getElementById("btn-restart");t&&t.addEventListener("click",()=>this.handleRestart());const s=document.getElementById("btn-pause");s&&s.addEventListener("click",()=>this.handlePauseToggle());const i=document.getElementById("btn-settings");i&&i.addEventListener("click",()=>this.handleSettings()),this._buildMainMenu()}_buildMainMenu(){this.domMenuLayer.classList.remove("hidden"),this.domMenuLayer.innerHTML=`
            <div class="menu-card">
                <h1 class="menu-title">CARROM</h1>
                <h3 class="menu-subtitle">CHAMPIONSHIP (LOCAL)</h3>
                
                <p class="menu-label">Select Number of Players:</p>
                <div class="menu-actions">
                    <button class="menu-btn premium-btn" data-players="2">2 Player</button>
                    <button class="menu-btn premium-btn" data-players="3">3 Player</button>
                    <button class="menu-btn premium-btn" data-players="4">4 Player</button>
                </div>
            </div>
        `,this.domMenuLayer.querySelectorAll(".menu-btn").forEach(t=>{t.addEventListener("click",s=>{const i=parseInt(s.target.getAttribute("data-players"));this.domMenuLayer.classList.add("hidden"),this.engine.turnManager.initPlayers(i),this._buildScoreboard(i),this.engine.stateMachine.setState("PLAYING"),this.engine.isRunning&&(this.engine.isRunning=!1),this.engine.start()})})}_buildScoreboard(e){const t=document.getElementById("scoreboard");let s="";for(let i=1;i<=e;i++)s+=`
                <div id="sb-p${i}" class="sb-player">
                    <div class="sb-name">Player ${i}</div>
                    <div class="turn-status"></div>
                    <div class="score-row">Score: <span class="sb-score" id="score-p${i}">0</span></div>
                    <div class="pieces-container" id="pieces-p${i}"></div>
                </div>
            `;t.innerHTML=s,t.style.display="flex",this.updateTurnHUD(1)}updateTurnHUD(e){document.querySelectorAll(".sb-player").forEach(i=>{i.classList.remove("active");const n=i.querySelector(".turn-status");n&&(n.innerText="")});const s=document.getElementById(`sb-p${e}`);if(s){s.classList.add("active");const i=s.querySelector(".turn-status");i&&(i.innerText="YOUR TURN")}}updatePocketedVisuals(e,t){e.forEach(s=>{const i=document.getElementById(`pieces-p${s.id}`);if(!i)return;if(!s.color){i.innerHTML="";return}const r=9-t.filter(l=>l.type===s.color&&l.isActive).length;let a="";for(let l=0;l<r;l++)a+=`<div class="piece-dot ${s.color}"></div>`;i.innerHTML=a})}handleRestart(){location.reload()}handlePauseToggle(){this.engine.isRunning&&(this.engine.pause(),this.domMenuLayer.classList.remove("hidden"),this.domMenuLayer.innerHTML=`
                <div class="pause-card">
                    <h1 class="pause-title">‚è∏ PAUSED</h1>
                    <button id="btn-resume" class="premium-btn">Resume Game</button>
                </div>
            `,document.getElementById("btn-resume").addEventListener("click",()=>{this.domMenuLayer.classList.add("hidden"),this.engine.start()}))}showBoardEnd(e,t,s){this.domMenuLayer.classList.remove("hidden");let i='<h1 class="result-title">BOARD COMPLETE</h1>';t&&s?i+=`<h2 class="result-subtitle">${t.name} wins the board (+${s} pts)</h2>`:i+='<h2 class="result-subtitle">Draw / No points awarded</h2>',i+='<div class="result-scores">',e.forEach(n=>{i+=`<div class="result-score-line">Player ${n.id} Score: <span class="score-value">${n.score}</span></div>`}),i+="</div>",this.domMenuLayer.innerHTML=`<div class="result-card">${i}</div>`,setTimeout(()=>{this.domMenuLayer.classList.add("hidden")},2500)}showGameOver(e,t){this.domMenuLayer.classList.remove("hidden");let s='<h1 class="champion-title">üëë CHAMPION!</h1>';s+=`<h2 class="result-subtitle">${e.name} has reached the winning score.</h2>`,s+='<div class="result-scores">',t.forEach(i=>{const n=i===e?" üëë":"";s+=`<div class="result-score-line">Player ${i.id} Final Score: <span class="score-value">${i.score}</span>${n}</div>`}),s+="</div>",s+='<div class="settings-actions"><button id="btn-restart-end" class="premium-btn">Play Again</button></div>',this.domMenuLayer.innerHTML=`<div class="result-card">${s}</div>`,document.getElementById("btn-restart-end").addEventListener("click",()=>{location.reload()})}handleSettings(){this.engine.pause(),this.domMenuLayer.classList.remove("hidden");const e=this.storage.data.settings;this.domMenuLayer.innerHTML=`
            <div class="settings-card">
                <h1 class="settings-title">‚öôÔ∏è Settings</h1>
                <div class="settings-row">
                    <span class="settings-label">Theme</span>
                    <span class="settings-value">${e.theme}</span>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Volume</span>
                    <span class="settings-value">${Math.round(e.volume*100)}%</span>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Difficulty</span>
                    <span class="settings-value">${e.difficulty}</span>
                </div>
                <div class="settings-actions">
                    <button id="btn-close-settings" class="premium-btn">Close</button>
                </div>
            </div>
        `,document.getElementById("btn-close-settings").addEventListener("click",()=>{this.domMenuLayer.classList.add("hidden"),this.engine.start()})}}class ee{constructor(){this.canvas=document.getElementById("game-canvas"),this.ctx=this.canvas.getContext("2d"),this.timeStep=1/120,this.maxSubSteps=10,this.accumulator=0,this.lastTime=0,this.virtualSize=900,this.physicsWorld=new q,this.boardRenderer=new O,this.storageManager=new J,this.audioManager=new j,this.particleSystem=new K,this.physicsWorld.onCollision=(e,t,s,i)=>{if(i>100){const n=Math.min(i/1e3,1);this.audioManager.playCollision(n),n>.5&&this.particleSystem.emitSparks(t,s,5,"#FFD700",n)}},this.stateMachine=new X(this),this.scoreSystem=new Q(this),this.foulSystem=new H(this),this.queenSystem=new U(this),this.turnManager=new z(this),this.uiController=new Z(this),this.striker=x.arrangeStandard(this.physicsWorld),this.pocketDetector=new W(this.physicsWorld,this.onPiecePocketed.bind(this)),this.inputManager=new Y(this.canvas,this.virtualSize),this.aimingSystem=new V(this.striker,this.physicsWorld),this.inputManager.events.onStart=e=>{if(this.stateMachine.currentState==="PLAYING"){this.audioManager.resume();const t=this.turnManager.activePlayer.baseline;this.aimingSystem.handleStart(e,t)}},this.inputManager.events.onMove=e=>{if(this.stateMachine.currentState==="PLAYING"){const t=this.turnManager.activePlayer.baseline;this.aimingSystem.handleMove(e,this.inputManager.pointerStart,t)}},this.inputManager.events.onEnd=e=>{this.stateMachine.currentState==="PLAYING"&&this.aimingSystem.handleEnd(e,this.inputManager.pointerStart)&&(this.audioManager.playCollision(.8),this.stateMachine.setState("SIMULATING"))},this.isRunning=!1,this._bindEvents(),this._resize()}isBoardSleeping(){return this.physicsWorld.bodies.every(e=>e.isSleeping)}onPiecePocketed(e){this.particleSystem.emitDust(e.pos.x,e.pos.y),this.audioManager.playPocketed(e.type),this.turnManager.onPiecePocketed(e)}restoreQueen(){const e=new A(450,450);this.physicsWorld.addBody(e)}resetBoard(){if(this.physicsWorld.bodies=[],this.striker=x.arrangeStandard(this.physicsWorld),this.aimingSystem.striker=this.striker,this.queenSystem._resetState(),this.turnManager.boardStarterIndex=((this.turnManager.boardStarterIndex||0)+1)%this.turnManager.players.length,this.turnManager.activePlayerIndex=this.turnManager.boardStarterIndex,this.turnManager.activePlayer=this.turnManager.players[this.turnManager.activePlayerIndex],this.turnManager.players.length===2){this.turnManager.players[this.turnManager.activePlayerIndex].color="white";const e=(this.turnManager.activePlayerIndex+1)%2;this.turnManager.players[e].color="black"}else this.turnManager.players.forEach(e=>e.color=null);this.turnManager._resetStriker(),this.turnManager._updateTurnHUD(),this.uiController&&this.uiController.updatePocketedVisuals(this.turnManager.players,this.physicsWorld.bodies),this.stateMachine.setState("PLAYING")}_bindEvents(){window.addEventListener("resize",()=>this._resize())}_resize(){const t=document.getElementById("canvas-wrapper").getBoundingClientRect(),s=Math.min(t.width,t.height)-20;s<=0||(this.canvas.width=s*window.devicePixelRatio,this.canvas.height=s*window.devicePixelRatio,this.canvas.style.width=`${s}px`,this.canvas.style.height=`${s}px`,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.canvas.width/this.virtualSize,this.canvas.height/this.virtualSize))}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),requestAnimationFrame(e=>this._loop(e)))}pause(){this.isRunning=!1}_loop(e){if(!this.isRunning)return;let t=(e-this.lastTime)/1e3;this.lastTime=e,t>.25&&(t=.25),this.accumulator+=t;let s=0;for(;this.accumulator>=this.timeStep&&s<this.maxSubSteps;)this.physicsWorld.step(this.timeStep),this.pocketDetector.update(),this.accumulator-=this.timeStep,s++;this.particleSystem.update(t),this.stateMachine.update(),this._render(),requestAnimationFrame(i=>this._loop(i))}_render(){this.ctx.clearRect(0,0,this.virtualSize,this.virtualSize),this.boardRenderer.render(this.ctx),this.stateMachine.currentState==="PLAYING"&&this.aimingSystem.render(this.ctx);const e=[...this.physicsWorld.bodies].sort((t,s)=>t.type==="striker"?1:s.type==="striker"?-1:0);for(let t of e)t.render&&t.render(this.ctx);this.particleSystem.render(this.ctx)}}window.addEventListener("DOMContentLoaded",()=>{const o=new ee;window.__engine__=o,o.start()});
