(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const p={boardSize:800,playingArea:720,borderWidth:40,pocketRadius:26,innerBase:235,outerBase:265,cornerCircleR:16,largeCircleR:235,middleCircleR:90,centerCircleR:15,padding:50,getPockets:function(){return[{x:105,y:105},{x:795,y:105},{x:105,y:795},{x:795,y:795}]},getBounds:function(){return{minX:90,minY:90,maxX:810,maxY:810}},getBaselines:function(){const a=450+(this.innerBase+this.outerBase)/2,t=450-(this.innerBase+this.outerBase)/2,e=450-this.outerBase,s=450+this.outerBase;return{bottom:{y:a,startX:e,endX:s,cutoutTargetLine:this.cornerCircleR},top:{y:t,startX:e,endX:s,cutoutTargetLine:this.cornerCircleR},left:{x:t,startY:e,endY:s,cutoutTargetLine:this.cornerCircleR},right:{x:a,startY:e,endY:s,cutoutTargetLine:this.cornerCircleR}}}};class F{constructor(){this.bodies=[],this.velocityIterations=20,this.onCollision=null,this.boardBounds=p.getBounds(),this.wallRestitution=.8}addBody(t){this.bodies.push(t)}removeBody(t){this.bodies=this.bodies.filter(e=>e!==t)}step(t){for(let e of this.bodies)e.update(t);for(let e=0;e<this.velocityIterations;e++)this._resolveBodyCollisions(),this._resolveWallCollisions()}_resolveBodyCollisions(){for(let t=0;t<this.bodies.length;t++){const e=this.bodies[t];for(let s=t+1;s<this.bodies.length;s++){const i=this.bodies[s],n=i.pos.x-e.pos.x,r=i.pos.y-e.pos.y,o=n*n+r*r,h=e.radius+i.radius;if(o<h*h){let l=Math.sqrt(o),c,y;l===0?(c=1,y=0,l=.1):(c=n/l,y=r/l);const f=h-l,b=Math.max(f-.01,0)/(e.invMass+i.invMass)*.8,m=c*b,S=y*b;e.pos.x-=m*e.invMass,e.pos.y-=S*e.invMass,i.pos.x+=m*i.invMass,i.pos.y+=S*i.invMass;const P=i.vel.x-e.vel.x,M=i.vel.y-e.vel.y,x=P*c+M*y;if(x>0)continue;let w=-(1+Math.min(e.restitution,i.restitution))*x;w/=e.invMass+i.invMass;const I=c*w,A=y*w;if(e.vel.x-=I*e.invMass,e.vel.y-=A*e.invMass,i.vel.x+=I*i.invMass,i.vel.y+=A*i.invMass,this.onCollision&&w>.5){const L=(e.pos.x+i.pos.x)/2,R=(e.pos.y+i.pos.y)/2;this.onCollision("body",L,R,w)}}}}}_resolveWallCollisions(){for(let t of this.bodies)t.pos.x-t.radius<this.boardBounds.minX?(t.pos.x=this.boardBounds.minX+t.radius,t.vel.x<0&&(t.vel.x*=-this.wallRestitution)):t.pos.x+t.radius>this.boardBounds.maxX&&(t.pos.x=this.boardBounds.maxX-t.radius,t.vel.x>0&&(t.vel.x*=-this.wallRestitution)),t.pos.y-t.radius<this.boardBounds.minY?(t.pos.y=this.boardBounds.minY+t.radius,t.vel.y<0&&(t.vel.y*=-this.wallRestitution)):t.pos.y+t.radius>this.boardBounds.maxY&&(t.pos.y=this.boardBounds.maxY-t.radius,t.vel.y>0&&(t.vel.y*=-this.wallRestitution))}renderDebug(t){t.strokeStyle="#0f0",t.beginPath();const e=this.boardBounds;t.rect(e.minX,e.minY,e.maxX-e.minX,e.maxY-e.minY),t.stroke();for(let s of this.bodies)t.fillStyle=s.color,t.beginPath(),t.arc(s.pos.x,s.pos.y,s.radius,0,Math.PI*2),t.fill()}}const _={"Classic Teak":{woodDark:"#a67d53",surface:"#e0cfae",lines:"#111111",linesAlpha:1,pocket:"#000000",pocketSupport:"#000000",redAccent:"#d26052"}};let v=_["Classic Teak"];typeof CanvasRenderingContext2D<"u"&&!CanvasRenderingContext2D.prototype.roundRect&&(CanvasRenderingContext2D.prototype.roundRect=function(a,t,e,s,i){typeof i=="number"&&(i={tl:i,tr:i,br:i,bl:i});const n={tl:0,tr:0,br:0,bl:0,...i};return this.beginPath(),this.moveTo(a+n.tl,t),this.lineTo(a+e-n.tr,t),this.quadraticCurveTo(a+e,t,a+e,t+n.tr),this.lineTo(a+e,t+s-n.br),this.quadraticCurveTo(a+e,t+s,a+e-n.br,t+s),this.lineTo(a+n.bl,t+s),this.quadraticCurveTo(a,t+s,a,t+s-n.bl),this.lineTo(a,t+n.tl),this.quadraticCurveTo(a,t,a+n.tl,t),this.closePath(),this});class q{constructor(){this.virtualSize=900,this.center={x:450,y:450}}render(t){this.drawOuterFrame(t),this.drawSurface(t),this.drawPockets(t),t.save(),t.translate(this.center.x,this.center.y),this.drawLines(t),t.restore()}drawOuterFrame(t){const{padding:e,boardSize:s}=p;t.shadowColor="rgba(0,0,0,0.8)",t.shadowBlur=30,t.shadowOffsetY=15,t.fillStyle=v.woodDark,t.beginPath(),t.roundRect(e,e,s,s,20),t.fill(),t.shadowColor="transparent",t.shadowBlur=0,t.shadowOffsetY=0}drawSurface(t){const{padding:e,borderWidth:s,playingArea:i}=p,n=e+s;t.fillStyle=v.surface,t.beginPath(),t.roundRect(n,n,i,i,5),t.fill(),t.strokeStyle=v.lines,t.lineWidth=2,t.stroke()}drawPockets(t){p.getPockets().forEach(s=>{t.fillStyle=v.pocket,t.beginPath(),t.arc(s.x,s.y,p.pocketRadius,0,Math.PI*2),t.fill();const i=t.createRadialGradient(s.x,s.y,p.pocketRadius*.2,s.x,s.y,p.pocketRadius);i.addColorStop(0,"rgba(0,0,0,1)"),i.addColorStop(1,"rgba(0,0,0,0.5)"),t.fillStyle=i,t.beginPath(),t.arc(s.x,s.y,p.pocketRadius,0,Math.PI*2),t.fill(),t.strokeStyle=v.pocketSupport,t.lineWidth=5,t.beginPath(),t.arc(s.x,s.y,p.pocketRadius+1,0,Math.PI*2),t.stroke()})}drawLines(t){t.strokeStyle=v.lines,t.globalAlpha=v.linesAlpha,this.drawLargeOverlays(t),this.drawCenterArea(t),this.drawDiagonals(t),this.drawBaselines(t),t.globalAlpha=1}drawLargeOverlays(t){t.lineWidth=1.5,t.beginPath(),t.arc(0,0,p.largeCircleR,0,Math.PI*2),t.stroke(),t.beginPath(),t.arc(0,0,p.middleCircleR,0,Math.PI*2),t.stroke()}drawCenterArea(t){t.lineWidth=1.5,t.beginPath(),t.arc(0,0,p.centerCircleR,0,Math.PI*2),t.stroke(),t.beginPath(),t.arc(0,0,4,0,Math.PI*2),t.fillStyle=v.lines,t.fill()}drawDiagonals(t){t.lineWidth=1.5;const s=i=>{t.save(),t.rotate(i);const n=300,r=140;t.beginPath(),t.moveTo(n,0),t.lineTo(r,0),t.stroke();const o=16;t.beginPath(),t.arc(160,0,o,0,Math.PI*2),t.stroke(),t.beginPath(),t.arc(r,0,o,0,Math.PI*2),t.stroke(),t.restore()};s(Math.PI/4),s(3*Math.PI/4),s(5*Math.PI/4),s(7*Math.PI/4)}drawBaselines(t){t.lineWidth=1.5;const e=p.outerBase,s=p.innerBase,i=p.cornerCircleR,n=(o,h,l,c)=>{t.beginPath(),t.moveTo(o,h),t.lineTo(l,c),t.stroke()};n(-e,-e,e,-e),n(-e,-s,e,-s),n(-e,e,e,e),n(-e,s,e,s),n(-e,-e,-e,e),n(-s,-e,-s,e),n(e,-e,e,e),n(s,-e,s,e);const r=(o,h)=>{t.beginPath(),t.arc(e*o,e*h,i,0,Math.PI*2),t.globalCompositeOperation="destination-out",t.fill(),t.globalCompositeOperation="source-over",t.stroke(),t.beginPath(),t.arc(s*o,s*h,i,0,Math.PI*2),t.fillStyle=v.redAccent,t.fill(),t.lineWidth=1.5,t.strokeStyle=v.lines,t.stroke()};r(1,1),r(1,-1),r(-1,1),r(-1,-1)}}class d{constructor(t=0,e=0){this.x=t,this.y=e}set(t,e){return this.x=t,this.y=e,this}copy(t){return this.x=t.x,this.y=t.y,this}clone(){return new d(this.x,this.y)}add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}mult(t){return this.x*=t,this.y*=t,this}div(t){return t!==0&&(this.x/=t,this.y/=t),this}magSq(){return this.x*this.x+this.y*this.y}mag(){return Math.sqrt(this.magSq())}normalize(){const t=this.mag();return t>0&&this.div(t),this}distSq(t){const e=this.x-t.x,s=this.y-t.y;return e*e+s*s}dist(t){return Math.sqrt(this.distSq(t))}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}limit(t){return this.magSq()>t*t&&this.normalize().mult(t),this}static add(t,e){return new d(t.x+e.x,t.y+e.y)}static sub(t,e){return new d(t.x-e.x,t.y-e.y)}static mult(t,e){return new d(t.x*e,t.y*e)}static dot(t,e){return t.x*e.x+t.y*e.y}}class O{constructor(t,e,s,i,n="piece"){this.pos=new d(t,e),this.vel=new d(0,0),this.radius=s,this.mass=i,this.invMass=i===0?0:1/i,this.type=n,this.color="#fff",this.highlight="#fff",this.isSleeping=!0,this.restitution=.88}applyImpulse(t,e=null){this.invMass!==0&&(this.vel.x+=t.x*this.invMass,this.vel.y+=t.y*this.invMass,this.isSleeping=!1)}update(t,e=1){this.vel.mult(Math.pow(.985*e,t*120)),this.vel.magSq()<.09?(this.vel.set(0,0),this.isSleeping=!0):this.isSleeping=!1,this.pos.x+=this.vel.x*t,this.pos.y+=this.vel.y*t}}class T extends O{constructor(t,e,s,i=1,n="piece"){super(t,e,s,i,n),this.restitution=.88,this.isActive=!0,this.rings=[[1,"#555"],[.7,"#ccc"]],this.highlight="rgba(255,255,255,0.4)"}render(t){if(!this.isActive)return;t.shadowColor="rgba(0,0,0,0.5)",t.shadowBlur=4,t.shadowOffsetX=2,t.shadowOffsetY=2;for(let s=0;s<this.rings.length;s++){const[i,n]=this.rings[s];t.fillStyle=n,t.beginPath(),t.arc(this.pos.x,this.pos.y,this.radius*i,0,Math.PI*2),t.fill(),t.shadowColor="transparent"}const e=t.createLinearGradient(this.pos.x-this.radius,this.pos.y-this.radius,this.pos.x+this.radius,this.pos.y+this.radius);e.addColorStop(0,this.highlight),e.addColorStop(1,"transparent"),t.fillStyle=e,t.beginPath(),t.arc(this.pos.x,this.pos.y,this.radius,0,Math.PI*2),t.fill()}}class C extends T{constructor(t,e){super(t,e,18,1,"black"),this.rings=[[1,"#1A1A1A"],[.65,"#F0F0F0"],[.5,"#222222"],[.18,"#F0F0F0"]],this.highlight="rgba(255,255,255,0.2)"}}class D extends T{constructor(t,e){super(t,e,18,1,"white"),this.rings=[[1,"#FDFDFD"],[.65,"#1A1A1A"],[.5,"#F0F0F0"],[.18,"#1A1A1A"]],this.highlight="rgba(255,255,255,0.7)"}}class E extends T{constructor(t,e){super(t,e,18,1,"queen"),this.rings=[[1,"#D10056"],[.65,"#FFFFFF"],[.5,"#E60073"],[.18,"#FFFFFF"]],this.highlight="rgba(255, 100, 200, 0.5)"}}class N extends T{constructor(t,e){super(t,e,24,2.85,"striker"),this.rings=[[1,"#0019C4"],[.85,"#FFFFFF"],[.72,"#0A31FF"],[.58,"#FFFFFF"],[.45,"#0A31FF"],[.25,"#FFFFFF"],[.08,"#0A31FF"]],this.highlight="rgba(255, 255, 255, 0.6)",this.restitution=.85}}const B={arrangeStandard(a){const n=new E(450,450);a.addBody(n);const r=[];for(let l=0;l<6;l++)r.push(-Math.PI/2+l*(Math.PI/3));for(let l=0;l<6;l++){const c=r[l],y=450+Math.cos(c)*36.36,f=450+Math.sin(c)*36.36,g=l%2===0?new D(y,f):new C(y,f);a.addBody(g)}for(let l=0;l<6;l++){const c=r[l],y=450+Math.cos(c)*36.36*2,f=450+Math.sin(c)*36.36*2;a.addBody(new C(y,f));const g=r[l]+Math.PI/6,u=36.36*Math.sqrt(3),b=450+Math.cos(g)*u,m=450+Math.sin(g)*u;a.addBody(new D(b,m))}const o=p.getBaselines(),h=new N(450,o.bottom.y);return a.addBody(h),h}};class Y{constructor(t,e){this.canvas=t,this.virtualSize=e,this.pointerDown=!1,this.pointerPos=new d(0,0),this.pointerStart=new d(0,0),this.events={onStart:null,onMove:null,onEnd:null},this._bindEvents()}_bindEvents(){this.canvas.addEventListener("mousedown",this._onStart.bind(this)),window.addEventListener("mousemove",this._onMove.bind(this)),window.addEventListener("mouseup",this._onEnd.bind(this)),this.canvas.addEventListener("touchstart",t=>this._onStart(t.touches[0],!0),{passive:!1}),window.addEventListener("touchmove",t=>this._onMove(t.touches[0],!0),{passive:!1}),window.addEventListener("touchend",this._onEnd.bind(this))}_getVirtualPos(t,e){const s=this.canvas.getBoundingClientRect(),i=this.virtualSize/s.width,n=this.virtualSize/s.height;return new d((t-s.left)*i,(e-s.top)*n)}_onStart(t,e=!1){e&&t.preventDefault&&t.preventDefault();const s=this._getVirtualPos(t.clientX,t.clientY);this.pointerDown=!0,this.pointerPos.copy(s),this.pointerStart.copy(s),this.events.onStart&&this.events.onStart(s)}_onMove(t,e=!1){if(!this.pointerDown)return;const s=this._getVirtualPos(t.clientX,t.clientY);this.pointerPos.copy(s),this.events.onMove&&this.events.onMove(s)}_onEnd(){this.pointerDown&&(this.pointerDown=!1,this.events.onEnd&&this.events.onEnd(this.pointerPos))}}class G{constructor(t){this.physics=t,this.maxReflections=3}predict(t,e){let s=t.pos.clone(),i=e.clone();const n=[s.clone()];let r=null,o=null,h=null,l=0,c=p.getBounds(),y=this.physics.bodies.filter(g=>g!==t),f=e.mag()*1.5;if(f<10)return{path:n,hitPiece:r,hitPos:o,ghostVelocity:h};for(let g=0;g<this.maxReflections+1&&f>0;g++){let u=this._findNextCollision(s,i,t.radius,c,y);if(u){let b=s.dist(u.point);if(f-=b,s=u.point,n.push(s.clone()),u.type==="piece"){r=u.piece,o=s.clone();const m=-i.x,S=-i.y,P=m*u.normal.x+S*u.normal.y,M=-(1+r.restitution)*P/(t.invMass+r.invMass);h=new d(-u.normal.x*M*r.invMass,-u.normal.y*M*r.invMass);break}else if(u.type==="wall"){const m=i.dot(u.normal);if(i.x-=2*m*u.normal.x,i.y-=2*m*u.normal.y,l++,l>=this.maxReflections)break}}else{i.normalize(),s.x+=i.x*f,s.y+=i.y*f,n.push(s.clone());break}}return{path:n,hitPiece:r,hitPos:o,ghostVelocity:h}}_findNextCollision(t,e,s,i,n){let r=1/0,o=null,h=e.x,l=e.y;if(h>0){let c=(i.maxX-s-t.x)/h;c>.001&&c<r&&(r=c,o={type:"wall",point:new d(i.maxX-s,t.y+l*c),normal:new d(-1,0)})}else if(h<0){let c=(i.minX+s-t.x)/h;c>.001&&c<r&&(r=c,o={type:"wall",point:new d(i.minX+s,t.y+l*c),normal:new d(1,0)})}if(l>0){let c=(i.maxY-s-t.y)/l;c>.001&&c<r&&(r=c,o={type:"wall",point:new d(t.x+h*c,i.maxY-s),normal:new d(0,-1)})}else if(l<0){let c=(i.minY+s-t.y)/l;c>.001&&c<r&&(r=c,o={type:"wall",point:new d(t.x+h*c,i.minY+s),normal:new d(0,1)})}for(let c of n){let y=t.x-c.pos.x,f=t.y-c.pos.y,g=h*h+l*l,u=2*(y*h+f*l),b=s+c.radius,m=y*y+f*f-b*b,S=u*u-4*g*m;if(S>=0){let P=(-u-Math.sqrt(S))/(2*g);if(P>.001&&P<r){r=P;let M=new d(t.x+h*P,t.y+l*P),x=M.x-c.pos.x,k=M.y-c.pos.y,w=Math.sqrt(x*x+k*k);o={type:"piece",piece:c,point:M,normal:new d(x/w,k/w)}}}}return o}}class ${constructor(t,e){this.striker=t,this.physicsWorld=e,this.predictor=new G(e),this.state="IDLE",this.maxPowerDist=200,this.maxVelocity=3400,this.currentPower=0,this.aimRefDir=new d(0,-1),this.predictionData=null,this.domPower=document.getElementById("power-bar-fill"),this.domPowerText=document.getElementById("power-display"),this.domAngleText=document.getElementById("angle-display")}handleStart(t,e="bottom"){const i=p.getBaselines()[e],n=60;if(this.striker.pos.distSq(t)<=this.striker.radius*this.striker.radius*4){this.state="DRAG_CHECK",this.currentPower=0,this.predictionData=null;return}let o=!1;e==="bottom"||e==="top"?Math.abs(t.y-i.y)<n&&t.x>i.startX-20&&t.x<i.endX+20&&(o=!0,this.state="POSITIONING",this.striker.pos.x=Math.max(i.startX,Math.min(i.endX,t.x))):Math.abs(t.x-i.x)<n&&t.y>i.startY-20&&t.y<i.endY+20&&(o=!0,this.state="POSITIONING",this.striker.pos.y=Math.max(i.startY,Math.min(i.endY,t.y))),o||(this.state="AIMING",this.currentPower=0,this.predictionData=null)}handleMove(t,e,s="bottom"){const i=e.x-t.x,n=e.y-t.y;if(this.state==="DRAG_CHECK"&&Math.sqrt(i*i+n*n)>5&&(s==="bottom"||s==="top"?Math.abs(i)>Math.abs(n)?this.state="POSITIONING":this.state="AIMING":Math.abs(n)>Math.abs(i)?this.state="POSITIONING":this.state="AIMING"),this.state==="POSITIONING"){const o=p.getBaselines()[s];if(s==="bottom"||s==="top"){const h=Math.max(o.startX,Math.min(o.endX,t.x));this.striker.pos.x=h}else{const h=Math.max(o.startY,Math.min(o.endY,t.y));this.striker.pos.y=h}}else if(this.state==="AIMING"){const r=new d(i,n),o=r.mag();o>5&&this.aimRefDir.copy(r).normalize();const h=Math.min(o/this.maxPowerDist,1);if(this.currentPower=h,this.currentPower>.05){const l=new d(this.aimRefDir.x,this.aimRefDir.y);l.mult(this.currentPower*this.maxVelocity),this.predictionData=this.predictor.predict(this.striker,l)}else this.predictionData=null;this.updateDOM()}}handleEnd(t,e){if(this.state==="AIMING"&&this.currentPower>.05){const s=new d(this.aimRefDir.x,this.aimRefDir.y);return s.mult(this.currentPower*this.maxVelocity),this.striker.vel.copy(s),this.striker.isSleeping=!1,this.state="IDLE",this.currentPower=0,this.predictionData=null,this.updateDOM(),!0}return this.state="IDLE",this.currentPower=0,this.predictionData=null,this.updateDOM(),!1}updateDOM(){if(this.domPower){const t=Math.round(this.currentPower*100);this.domPower.style.width=`${t}%`,this.domPowerText.innerText=`${t}%`;let e="#ffffff";t>75?e="#ff4400":t>50?e="#ffa500":t>25&&(e="#ffff00"),this.domPower.style.background=e;let s=Math.atan2(this.aimRefDir.y,this.aimRefDir.x)*(180/Math.PI);s=Math.round(s<0?s+360:s),this.domAngleText.innerText=`${s}Â°`}}render(t){if(this.state==="AIMING"){let e=255,s=255-this.currentPower*200,i=255-this.currentPower*255;const n=`rgba(${e}, ${Math.max(0,s)}, ${Math.max(0,i)}`;if(this.predictionData&&this.predictionData.path.length>1){const r=this.predictionData.path;t.lineWidth=3;for(let o=0;o<r.length-1;o++){const h=.8-o*.2;t.strokeStyle=`${n}, ${h})`,o>0?t.setLineDash([8,8]):t.setLineDash([]),t.beginPath(),t.moveTo(r[o].x,r[o].y),t.lineTo(r[o+1].x,r[o+1].y),t.stroke()}if(t.setLineDash([]),this.predictionData.hitPos&&(t.strokeStyle=`${n}, 0.6)`,t.setLineDash([4,4]),t.beginPath(),t.arc(this.predictionData.hitPos.x,this.predictionData.hitPos.y,this.striker.radius,0,Math.PI*2),t.stroke(),t.setLineDash([]),this.predictionData.ghostVelocity&&this.predictionData.hitPiece)){const o=new d(this.predictionData.hitPiece.pos.x+this.predictionData.ghostVelocity.x*.05,this.predictionData.hitPiece.pos.y+this.predictionData.ghostVelocity.y*.05);t.strokeStyle="rgba(255,255,255,0.3)",t.beginPath(),t.moveTo(this.predictionData.hitPiece.pos.x,this.predictionData.hitPiece.pos.y),t.lineTo(o.x,o.y),t.stroke()}}else{t.strokeStyle=`${n}, 0.5)`,t.lineWidth=3,t.setLineDash([10,15]),t.beginPath(),t.moveTo(this.striker.pos.x,this.striker.pos.y);const r=400*this.currentPower+100;t.lineTo(this.striker.pos.x+this.aimRefDir.x*r,this.striker.pos.y+this.aimRefDir.y*r),t.stroke(),t.setLineDash([])}t.strokeStyle=`${n}, 0.8)`,t.lineWidth=3,t.beginPath(),t.arc(this.striker.pos.x,this.striker.pos.y,this.striker.radius+15+this.currentPower*10,0,Math.PI*2),t.stroke()}}}class V{constructor(t,e){this.physics=t,this.pockets=p.getPockets(),this.triggerRadiusSq=32*32,this.onPocketedCallback=e}update(){for(let t=this.physics.bodies.length-1;t>=0;t--){let e=this.physics.bodies[t];for(let s of this.pockets){const i=e.pos.x-s.x,n=e.pos.y-s.y;if(i*i+n*n<this.triggerRadiusSq){this._handlePocket(e,t);break}}}}_handlePocket(t,e){this.physics.bodies.splice(e,1),this.onPocketedCallback&&this.onPocketedCallback(t)}}class z{constructor(t){this.engine=t,this.currentState="MENU"}setState(t){this.currentState!==t&&(console.log(`State Transition: ${this.currentState} -> ${t}`),this.currentState=t,t==="PLAYING"?this.engine.aimingSystem&&(this.engine.aimingSystem.state="IDLE"):t==="SIMULATING"||t==="EVALUATING"&&this.engine.turnManager.evaluateShot())}update(){this.currentState==="SIMULATING"&&this.engine.isBoardSleeping()&&this.setState("EVALUATING")}}class W{constructor(t){this.engine=t,this.players=[],this.activePlayerIndex=0,this.activePlayer=null,this.turnPocketed=[],this.initPlayers(2)}initPlayers(t){this.players=[];let e;t===2?e=["bottom","top"]:t===3?e=["bottom","right","top"]:e=["bottom","right","top","left"];for(let s=0;s<t;s++)this.players.push({id:s+1,name:`P${s+1}`,score:0,fouls:0,baseline:e[s]});t===2?(this.players[0].color="white",this.players[1].color="black"):t===4?(this.players[0].color="white",this.players[1].color="black",this.players[2].color="white",this.players[3].color="black"):this.players.forEach(s=>s.color=null),this.activePlayerIndex=0,this.activePlayer=this.players[0]}onPiecePocketed(t){this.turnPocketed.push(t),t.type==="striker"?this._showSplash("foul-splash"):t.type==="queen"?this._showSplash("queen-splash"):(t.type==="white"||t.type==="black")&&(this.activePlayer.color||(this.activePlayer.color=t.type),t.type===this.activePlayer.color&&this.engine.scoreSystem.addPoints(this.activePlayer,10)),this.engine.uiController&&this.engine.uiController.updatePocketedVisuals(this.players,this.engine.physicsWorld.bodies)}evaluateShot(){let t=!1,e=!1;const s=this.engine.foulSystem,i=this.engine.queenSystem;this.engine.scoreSystem;let n=!1,r=0,o=!1;for(let l of this.turnPocketed)l.type==="striker"?n=!0:l.type==="queen"?o=!0:(l.type==="white"||l.type==="black")&&(this.activePlayer.color||(this.activePlayer.color=l.type),l.type===this.activePlayer.color&&r++);n&&(s.handleStrikerFoul(this.activePlayer),t=!0),t&&r>0&&(this.activePlayer.dues=(this.activePlayer.dues||0)+r),o&&!t&&(i.handleQueenPocketed(this.activePlayer),e=!0),i.evaluateCover(this.activePlayer,r,t),t||r>0&&(e=!0),s.processDues(this.activePlayer),this.turnPocketed=[],this._checkBoardEnd()||((t||!e)&&this._switchTurn(),this._resetStriker(),this.engine.stateMachine.currentState!=="GAME_OVER"&&this.engine.stateMachine.setState("PLAYING")),this.engine.uiController&&this.engine.uiController.updatePocketedVisuals(this.players,this.engine.physicsWorld.bodies)}_checkBoardEnd(){if(!this.activePlayer.color)return!1;if(this.engine.physicsWorld.bodies.filter(e=>e.type===this.activePlayer.color).length===0){const e=this.players.find(n=>n.color&&n.color!==this.activePlayer.color)||this.players[1],s=this.engine.queenSystem;if(this.engine.physicsWorld.bodies.some(n=>n.type==="queen"))console.log("Foul: Pocketed last piece before Queen! Opponent wins the board."),this.engine.scoreSystem.evaluateBoardEnd(e,this.activePlayer,!0);else{const n=s.queenCoveredBy===this.activePlayer;this.engine.scoreSystem.evaluateBoardEnd(this.activePlayer,e,n)}return!0}return!1}_switchTurn(){this.activePlayerIndex=(this.activePlayerIndex+1)%this.players.length,this.activePlayer=this.players[this.activePlayerIndex],this._updateTurnHUD()}_resetStriker(){const t=this.engine.striker,e=p.getBaselines();t.vel.set(0,0),t.isSleeping=!0;const s=this.activePlayer.baseline;s==="bottom"?t.pos.set(450,e.bottom.y):s==="top"?t.pos.set(450,e.top.y):s==="left"?t.pos.set(e.left.x,450):s==="right"&&t.pos.set(e.right.x,450),this.engine.physicsWorld.bodies.includes(t)||this.engine.physicsWorld.addBody(t)}_updateTurnHUD(){this.engine.uiController&&this.engine.uiController.updateTurnHUD(this.activePlayer.id)}_showSplash(t){const e=document.getElementById(t);e&&(e.classList.remove("hidden"),e.style.animation="none",e.offsetHeight,e.style.animation=null,setTimeout(()=>{e.classList.add("hidden")},1500))}}class X{constructor(t){this.engine=t}handleStrikerFoul(t){console.log(`FOUL: ${t.name} pocketed the striker.`),t.fouls+=1,t.dues=(t.dues||0)+1,this.processDues(t)}processDues(t){if(!t.dues||t.dues<=0||!t.color)return;this.engine.physicsWorld.bodies.filter(s=>s.type===t.color).length<9?(this._returnPiece(t.color),t.dues-=1,t.dues>0&&this.processDues(t)):console.log(`${t.name} owes a Due but has no pieces pocketed yet! It remains outstanding.`)}_returnPiece(t){const i=t==="white"?new D(450,450):new C(450,450);this.engine.physicsWorld.addBody(i)}}class H{constructor(t){this.engine=t,this.queenPocketedBy=null,this.queenCoveredBy=null,this.needsCover=!1,this.justPocketed=!1}handleQueenPocketed(t){console.log(`QUEEN Pocketed by ${t.name}. Must cover!`),this.queenPocketedBy=t,this.queenCoveredBy=null,this.needsCover=!0,this.justPocketed=!0}evaluateCover(t,e,s){if(this.needsCover){if(this.justPocketed){s?(console.log("Foul while pocketing Queen! Queen returns."),this._returnQueen()):e>0?(console.log("QUEEN POCKETED AND COVERED IN SAME SHOT!"),this._markCovered()):(console.log("Queen pocketed, needs cover on next shot."),this.justPocketed=!1);return}if(this.queenPocketedBy!==t){console.log("Cover failed! Player changed. Queen returns to board."),this._returnQueen();return}e>0&&!s?(console.log("QUEEN COVERED SUCCESSFULLY!"),this._markCovered()):s?(console.log("Foul during Queen cover! Queen returns."),this._returnQueen()):(console.log("Cover shot failed (no pieces pocketed). Queen returns."),this._returnQueen())}}_markCovered(){this.queenCoveredBy=this.queenPocketedBy,this.needsCover=!1,this.justPocketed=!1}_returnQueen(){this.engine.restoreQueen(),this._resetState()}_resetState(){this.queenPocketedBy=null,this.queenCoveredBy=null,this.needsCover=!1,this.justPocketed=!1}}class U{constructor(t){this.engine=t,this.winningScore=150}addPoints(t,e){t.score+=e,console.log(`${t.name} scored ${e} points! Total: ${t.score}`),this._updateHUD(t),this.checkWin(t)}deductPoints(t,e){this._updateHUD(t)}evaluateBoardEnd(t,e,s){let n=this.engine.physicsWorld.bodies.filter(r=>r.type===e.color).length*10;s&&(n+=30),this.addPoints(t,n),t.score<this.winningScore&&e.score<this.winningScore&&(this.engine.uiController&&this.engine.uiController.showBoardEnd(this.engine.turnManager.players,t,n),setTimeout(()=>{this.engine.resetBoard()},3e3))}checkWin(t){t.score>=this.winningScore&&(console.log(`============= ${t.name} WINS THE GAME! =============`),this.engine.stateMachine.setState("GAME_OVER"),this.engine.uiController&&this.engine.uiController.showGameOver(t,this.engine.turnManager.players))}_updateHUD(t){const e=document.getElementById(`score-p${t.id}`);e&&(e.innerText=t.score)}}class Q{constructor(){const t=window.AudioContext||window.webkitAudioContext;this.ctx=new t,this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=.5,this.masterGain.connect(this.ctx.destination)}resume(){this.ctx.state==="suspended"&&this.ctx.resume()}playCollision(t){this.resume();const e=this.ctx.createOscillator(),s=this.ctx.createGain();e.type="triangle",e.frequency.setValueAtTime(400+t*400,this.ctx.currentTime),e.frequency.exponentialRampToValueAtTime(100,this.ctx.currentTime+.1);let i=Math.min(t*.5+.1,1);s.gain.setValueAtTime(i,this.ctx.currentTime),s.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.1),e.connect(s),s.connect(this.masterGain),e.start(),e.stop(this.ctx.currentTime+.1)}playPocketed(t){this.resume();const e=this.ctx.createOscillator(),s=this.ctx.createGain();t==="queen"?(e.type="sine",e.frequency.setValueAtTime(880,this.ctx.currentTime),e.frequency.setValueAtTime(1108,this.ctx.currentTime+.1),e.frequency.setValueAtTime(1318,this.ctx.currentTime+.2),s.gain.setValueAtTime(.5,this.ctx.currentTime),s.gain.linearRampToValueAtTime(0,this.ctx.currentTime+.6),e.connect(s),s.connect(this.masterGain),e.start(),e.stop(this.ctx.currentTime+.6)):t==="striker"?(e.type="sawtooth",e.frequency.setValueAtTime(150,this.ctx.currentTime),e.frequency.linearRampToValueAtTime(100,this.ctx.currentTime+.3),s.gain.setValueAtTime(.4,this.ctx.currentTime),s.gain.linearRampToValueAtTime(0,this.ctx.currentTime+.3),e.connect(s),s.connect(this.masterGain),e.start(),e.stop(this.ctx.currentTime+.3)):(e.type="sine",e.frequency.setValueAtTime(300,this.ctx.currentTime),e.frequency.exponentialRampToValueAtTime(50,this.ctx.currentTime+.3),s.gain.setValueAtTime(.6,this.ctx.currentTime),s.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.3),e.connect(s),s.connect(this.masterGain),e.start(),e.stop(this.ctx.currentTime+.3))}}class j{constructor(){this.particles=[],this.maxParticles=500}emitSparks(t,e,s=5,i="#FFD700",n=1){for(let r=0;r<s&&!(this.particles.length>=this.maxParticles);r++){const o=Math.random()*Math.PI*2,h=Math.random()*(100*n)+50,l=Math.random()*.3+.2;this.particles.push({x:t,y:e,vx:Math.cos(o)*h,vy:Math.sin(o)*h,life:l,maxLife:l,color:i,size:Math.random()*3+1})}}emitDust(t,e){for(let s=0;s<15&&!(this.particles.length>=this.maxParticles);s++){const i=Math.random()*Math.PI*2,n=Math.random()*80+20,r=Math.random()*.4+.3;this.particles.push({x:t,y:e,vx:Math.cos(i)*n,vy:Math.sin(i)*n,life:r,maxLife:r,color:"rgba(255,255,255,0.4)",size:Math.random()*4+2})}}update(t){for(let e=this.particles.length-1;e>=0;e--){let s=this.particles[e];if(s.life-=t,s.life<=0){this.particles.splice(e,1);continue}s.vx*=.95,s.vy*=.95,s.x+=s.vx*t,s.y+=s.vy*t}}render(t){if(this.particles.length!==0){t.save();for(let e of this.particles){const s=e.life/e.maxLife;t.globalAlpha=s,t.fillStyle=e.color,t.beginPath(),t.arc(e.x,e.y,e.size,0,Math.PI*2),t.fill()}t.restore()}}}class K{constructor(){this.storageKey="carrom_save_data",this.data={coins:0,level:1,xp:0,stats:{gamesPlayed:0,wins:0,fouls:0,queensPocketed:0},settings:{volume:.8,theme:"Classic Teak",difficulty:"medium"}},this.load()}load(){try{const t=localStorage.getItem(this.storageKey);if(t){const e=JSON.parse(t);this.data={...this.data,...e},e.stats&&(this.data.stats={...this.data.stats,...e.stats}),e.settings&&(this.data.settings={...this.data.settings,...e.settings})}}catch(t){console.warn("Could not load save data",t)}}save(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.data))}catch(t){console.warn("Could not save data",t)}}addCoins(t){this.data.coins+=t,this.save()}addXP(t){this.data.xp+=t;const e=this.data.level*1e3;this.data.xp>=e&&(this.data.level++,this.data.xp-=e,console.log(`Level Up! You are now level ${this.data.level}`)),this.save()}}class J{constructor(t){this.engine=t,this.storage=t.storageManager,this.domMenuLayer=document.getElementById("ui-layer");const e=document.getElementById("btn-restart");e&&e.addEventListener("click",()=>this.handleRestart());const s=document.getElementById("btn-pause");s&&s.addEventListener("click",()=>this.handlePauseToggle());const i=document.getElementById("btn-settings");i&&i.addEventListener("click",()=>this.handleSettings()),this._buildMainMenu()}_buildMainMenu(){this.domMenuLayer.classList.remove("hidden"),this.domMenuLayer.innerHTML=`
            <div style="background: rgba(40, 20, 10, 0.95); padding: 40px; border-radius: 20px; text-align: center; border: 2px solid #FFD700; box-shadow: 0 10px 50px rgba(0,0,0,0.8); min-width: 400px;">
                <h1 style="font-family: var(--font-title); font-size: 3rem; margin-bottom: 5px; color: #FFF; text-shadow: 0 5px 15px rgba(255, 215, 0, 0.5);">CARROM</h1>
                <h3 style="color: var(--text-accent); margin-bottom: 30px; letter-spacing: 5px; font-weight: normal;">CHAMPIONSHIP (LOCAL)</h3>
                
                <p style="margin-bottom: 20px; color: #fff;">Select Number of Players:</p>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="menu-btn" data-players="2" style="flex:1; padding: 15px; background: linear-gradient(to bottom, #C8860A, #A0680A); border: 2px solid #FFD700; color: white; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.2rem;">2 Player</button>
                    <button class="menu-btn" data-players="3" style="flex:1; padding: 15px; background: linear-gradient(to bottom, #C8860A, #A0680A); border: 2px solid #FFD700; color: white; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.2rem;">3 Player</button>
                    <button class="menu-btn" data-players="4" style="flex:1; padding: 15px; background: linear-gradient(to bottom, #C8860A, #A0680A); border: 2px solid #FFD700; color: white; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.2rem;">4 Player</button>
                </div>
            </div>
        `,this.domMenuLayer.querySelectorAll(".menu-btn").forEach(e=>{e.addEventListener("click",s=>{const i=parseInt(s.target.getAttribute("data-players"));this.domMenuLayer.classList.add("hidden"),this.engine.turnManager.initPlayers(i),this._buildScoreboard(i),this.engine.stateMachine.currentState="MENU",this.engine.stateMachine.setState("PLAYING"),this.engine.isRunning=!1,this.engine.start()})})}_buildScoreboard(t){const e=document.getElementById("scoreboard");let s="";for(let i=1;i<=t;i++)s+=`
                <div id="sb-p${i}" class="sb-player">
                    <div class="sb-name">Player ${i}</div>
                    <div class="turn-status" style="font-size: 0.8rem; font-weight: bold; height: 1.2rem; margin-top: 2px;"></div>
                    <div style="font-size: 0.9rem; margin-top: 2px; color: #fff;">Score: <span class="sb-score" id="score-p${i}">0</span></div>
                    <div class="pieces-container" id="pieces-p${i}" style="margin-top: 5px; min-height: 14px; gap: 4px; justify-content: center;"></div>
                </div>
            `;e.innerHTML=s,e.style.display="flex",this.updateTurnHUD(1)}updateTurnHUD(t){document.querySelectorAll(".sb-player").forEach(i=>{i.style.opacity="0.5",i.style.transform="scale(0.9)",i.style.border="none";const n=i.querySelector(".turn-status");n&&(n.innerText="")});const s=document.getElementById(`sb-p${t}`);if(s){s.style.opacity="1",s.style.transform="scale(1.1)",s.style.border="2px solid #FFD700",s.style.borderRadius="10px",s.style.padding="5px 15px",s.style.boxShadow="0 0 15px rgba(255, 215, 0, 0.6)";const i=s.querySelector(".turn-status");i&&(i.innerText="YOUR TURN",i.style.color="#FFD700",i.style.textShadow="0 0 5px rgba(255,215,0,0.8)")}}updatePocketedVisuals(t,e){t.forEach(s=>{const i=document.getElementById(`pieces-p${s.id}`);if(!i)return;if(!s.color){i.innerHTML="";return}const r=9-e.filter(h=>h.type===s.color&&h.isActive).length;let o="";for(let h=0;h<r;h++)o+=`<div class="piece-dot ${s.color}"></div>`;i.innerHTML=o})}handleRestart(){location.reload()}handlePauseToggle(){this.engine.isRunning&&(this.engine.pause(),this.domMenuLayer.classList.remove("hidden"),this.domMenuLayer.innerHTML='<h1 style="color:white; font-size: 4rem;">PAUSED</h1><br><button id="btn-resume" style="padding: 10px 20px; font-size: 1.5rem; margin-top:20px;">Resume</button>',document.getElementById("btn-resume").addEventListener("click",()=>{this.domMenuLayer.classList.add("hidden"),this.engine.start()}))}showBoardEnd(t,e,s){this.domMenuLayer.classList.remove("hidden");let i='<h1 style="color:var(--text-accent); font-size:3rem; margin-bottom: 20px;">BOARD COMPLETE</h1>';e&&s?i+=`<h2 style="color:white; margin-bottom: 20px;">${e.name} wins the board (+${s} pts)</h2>`:i+='<h2 style="color:white; margin-bottom: 20px;">Draw / No points awarded</h2>',i+='<div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">',t.forEach(n=>{i+=`<div style="font-size: 1.5rem; color: #fff;">Player ${n.id} Score: <span style="color:var(--text-accent); font-weight:bold;">${n.score}</span></div>`}),i+="</div>",this.domMenuLayer.innerHTML=`<div style="background: rgba(40, 20, 10, 0.95); padding: 50px; border-radius: 20px; text-align: center; border: 2px solid #FFD700; box-shadow: 0 10px 50px rgba(0,0,0,0.8);">${i}</div>`,setTimeout(()=>{this.domMenuLayer.classList.add("hidden")},2500)}showGameOver(t,e){this.domMenuLayer.classList.remove("hidden");let s='<h1 style="color:var(--text-accent); font-size:4rem; margin-bottom: 20px;">CHAMPION!</h1>';s+=`<h2 style="color:white; margin-bottom: 20px;">${t.name} has reached the winning score.</h2>`,s+='<div style="display:flex; flex-direction:column; gap:10px; margin-top:20px; margin-bottom: 30px;">',e.forEach(i=>{const n=i===t?" ðŸ‘‘":"";s+=`<div style="font-size: 1.5rem; color: #fff;">Player ${i.id} Final Score: <span style="color:var(--text-accent); font-weight:bold;">${i.score}</span>${n}</div>`}),s+="</div>",s+='<button id="btn-restart-end" style="padding: 15px 30px; background: linear-gradient(to bottom, #C8860A, #A0680A); border: 2px solid #FFD700; color: white; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.2rem;">Play Again</button>',this.domMenuLayer.innerHTML=`<div style="background: rgba(40, 20, 10, 0.95); padding: 50px; border-radius: 20px; text-align: center; border: 2px solid #FFD700; box-shadow: 0 10px 50px rgba(0,0,0,0.8);">${s}</div>`,document.getElementById("btn-restart-end").addEventListener("click",()=>{location.reload()})}handleSettings(){alert(`Settings
Theme: ${this.storage.data.settings.theme}
Volume: ${this.storage.data.settings.volume}`)}}class Z{constructor(){this.canvas=document.getElementById("game-canvas"),this.ctx=this.canvas.getContext("2d"),this.timeStep=1/120,this.maxSubSteps=10,this.accumulator=0,this.lastTime=0,this.virtualSize=900,this.physicsWorld=new F,this.boardRenderer=new q,this.storageManager=new K,this.audioManager=new Q,this.particleSystem=new j,this.physicsWorld.onCollision=(t,e,s,i)=>{if(i>100){const n=Math.min(i/1e3,1);this.audioManager.playCollision(n),n>.5&&this.particleSystem.emitSparks(e,s,5,"#FFD700",n)}},this.stateMachine=new z(this),this.scoreSystem=new U(this),this.foulSystem=new X(this),this.queenSystem=new H(this),this.turnManager=new W(this),this.uiController=new J(this),this.striker=B.arrangeStandard(this.physicsWorld),this.pocketDetector=new V(this.physicsWorld,this.onPiecePocketed.bind(this)),this.inputManager=new Y(this.canvas,this.virtualSize),this.aimingSystem=new $(this.striker,this.physicsWorld),this.inputManager.events.onStart=t=>{if(this.stateMachine.currentState==="PLAYING"){this.audioManager.resume();const e=this.turnManager.activePlayer.baseline;this.aimingSystem.handleStart(t,e)}},this.inputManager.events.onMove=t=>{if(this.stateMachine.currentState==="PLAYING"){const e=this.turnManager.activePlayer.baseline;this.aimingSystem.handleMove(t,this.inputManager.pointerStart,e)}},this.inputManager.events.onEnd=t=>{this.stateMachine.currentState==="PLAYING"&&this.aimingSystem.handleEnd(t,this.inputManager.pointerStart)&&(this.audioManager.playCollision(.8),this.stateMachine.setState("SIMULATING"))},this.isRunning=!1,this._bindEvents(),this._resize()}isBoardSleeping(){return this.physicsWorld.bodies.every(t=>t.isSleeping)}onPiecePocketed(t){this.particleSystem.emitDust(t.pos.x,t.pos.y),this.audioManager.playPocketed(t.type),this.turnManager.onPiecePocketed(t)}restoreQueen(){const t=new E(450,450);this.physicsWorld.addBody(t)}resetBoard(){if(this.physicsWorld.bodies=[],this.striker=B.arrangeStandard(this.physicsWorld),this.aimingSystem.striker=this.striker,this.queenSystem._resetState(),this.turnManager.boardStarterIndex=((this.turnManager.boardStarterIndex||0)+1)%this.turnManager.players.length,this.turnManager.activePlayerIndex=this.turnManager.boardStarterIndex,this.turnManager.activePlayer=this.turnManager.players[this.turnManager.activePlayerIndex],this.turnManager.players.length===2){this.turnManager.players[this.turnManager.activePlayerIndex].color="white";const t=(this.turnManager.activePlayerIndex+1)%2;this.turnManager.players[t].color="black"}else this.turnManager.players.forEach(t=>t.color=null);this.turnManager._resetStriker(),this.turnManager._updateTurnHUD(),this.uiController&&this.uiController.updatePocketedVisuals(this.turnManager.players,this.physicsWorld.bodies),this.stateMachine.setState("PLAYING")}_bindEvents(){window.addEventListener("resize",()=>this._resize())}_resize(){const e=document.getElementById("canvas-wrapper").getBoundingClientRect(),s=Math.min(e.width,e.height)-20;s<=0||(this.canvas.width=s*window.devicePixelRatio,this.canvas.height=s*window.devicePixelRatio,this.canvas.style.width=`${s}px`,this.canvas.style.height=`${s}px`,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.canvas.width/this.virtualSize,this.canvas.height/this.virtualSize))}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),requestAnimationFrame(t=>this._loop(t)))}pause(){this.isRunning=!1}_loop(t){if(!this.isRunning)return;let e=(t-this.lastTime)/1e3;this.lastTime=t,e>.25&&(e=.25),this.accumulator+=e;let s=0;for(;this.accumulator>=this.timeStep&&s<this.maxSubSteps;)this.physicsWorld.step(this.timeStep),this.pocketDetector.update(),this.accumulator-=this.timeStep,s++;this.particleSystem.update(e),this.stateMachine.update(),this._render(),requestAnimationFrame(i=>this._loop(i))}_render(){this.ctx.clearRect(0,0,this.virtualSize,this.virtualSize),this.boardRenderer.render(this.ctx),this.isBoardSleeping()&&this.aimingSystem.render(this.ctx);const t=[...this.physicsWorld.bodies].sort((e,s)=>e.type==="striker"?1:s.type==="striker"?-1:0);for(let e of t)e.render&&e.render(this.ctx);this.particleSystem.render(this.ctx)}}window.addEventListener("DOMContentLoaded",()=>{const a=new Z;window.__engine__=a,a.start()});
